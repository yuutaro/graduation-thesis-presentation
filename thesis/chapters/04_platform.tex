\section{実験環境：一点物売買プラットフォーム}
\label{chap:platform}

本研究では，提案するデータ生成エージェントの有効性を検証するための実験環境として，一点物の取引に特化したWebプラットフォームを実際に開発した．本章では，このプラットフォームの概要，技術構成，およびテストデータに求められる要件について述べる．

\subsection{プラットフォームの概要}
開発したプラットフォームは，クリエイターが制作した「作品」を制作背景とともに販売・購入できるCtoCマーケットプレイスである．
本プラットフォームでは，作品の説明文に加えて制作背景や制作過程の記録（制作ログ）を保存・提示できることを重視し，作品単体の情報だけでなく，活動の文脈も含めて閲覧できるように設計した．

主な特徴は以下の通りである．
\begin{itemize}
	\item \textbf{プロジェクトベースの活動}: ユーザーは単独で出品するだけでなく，プロジェクトを立ち上げ，複数人で協力して制作・販売を行うことができる．
	\item \textbf{制作ログの重視}: 作品の完成形だけでなく，使用した素材，制作中の失敗，試行錯誤の履歴をログとして記録し，作品価値の一部として提示する．
	\item \textbf{複雑な権利・収益分配}: 一つの作品に対し，素材提供者，制作者，プロジェクト主催者など複数のステークホルダーが存在し，売上はStripe Connectを通じて自動的に分配される．
\end{itemize}

\subsection{システム構成}
本プラットフォームは，フロントエンド/バックエンド/データベース/決済基盤を分離した構成で実装した（図\ref{fig:platform_architecture}）．

\begin{figure}[t]
	\centering
	\resizebox{0.95\textwidth}{!}{%
		\begin{tikzpicture}[
				node distance=1.5cm and 3.5cm,
				box/.style={draw, rectangle, rounded corners, align=center, minimum width=3.5cm, minimum height=2cm, fill=white, thick},
				db/.style={draw, cylinder, shape border rotate=90, aspect=0.25, align=center, minimum width=2.5cm, minimum height=2cm, fill=white, thick},
				cloud/.style={draw, ellipse, align=center, minimum width=3cm, minimum height=1.5cm, fill=white, thick},
				arrow/.style={-Latex, thick, <->},
				label_text/.style={font=\footnotesize, align=center}
			]
			% Nodes
			\node[box] (frontend) {\textbf{Frontend / BFF}\\(Next.js)};
			\node[box, right=of frontend] (backend) {\textbf{Backend API}\\(NestJS)};
			\node[db, below=of backend] (database) {\textbf{Database}\\(PostgreSQL)};
			\node[cloud, right=of backend] (stripe) {\textbf{Payment Infra}\\(Stripe Connect)};

			% Connections
			\draw[arrow] (frontend) -- node[midway, above, label_text] {REST / Server Actions} (backend);
			\draw[arrow] (backend) -- node[midway, left, label_text] {Prisma ORM} (database);
			\draw[arrow] (backend) -- node[midway, above, label_text] {SDK / Webhook} (stripe);

			% User Interaction
			\node[left=1.5cm of frontend] (user) {\textbf{User}};
			\draw[arrow, ->] (user) -- node[midway, above, label_text] {HTTPS} (frontend);

		\end{tikzpicture}
	}
	\caption{Payment Platform 2 のシステム構成}
	\label{fig:platform_architecture}
\end{figure}

\subsubsection{フロントエンド}
ユーザーとの接点となるフロントエンドには，Reactベースのフレームワークである Next.js (App Router) \cite{nextjs} を採用した．本システムでは，単なる画面描画だけでなく，サーバーサイドでのデータフェッチや認証セッション管理を行うBFFとしての役割も担わせている．

\paragraph{ディレクトリベース・ルーティングの採用}
ソースコード構成（src/app配下）において，ファイルシステムの階層構造をそのままURLパスにマッピングするディレクトリベース・ルーティングを採用した．
例えば，クリエイターのポートフォリオページは src/app/[userPubId]/page.tsx，作品詳細ページは src/app/[userPubId]/[itemPubId]/page.tsx として配置している．このように動的パラメータをディレクトリ名に含めることで，ユーザーおよび作品の公開識別子をURLに反映したページ構成を実装できる．

\paragraph{Server Actionsとデータ取得の最適化}
コンポーネント設計においては，React Server Components (RSC) を全面的に採用した．作品情報（Markdownテキスト）やユーザープロファイルなどの静的な初期データは，サーバーサイドでデータベース（またはバックエンドAPI）から直接取得し，HTMLとしてクライアントに送信される．
また，フォーム送信や入札アクションなどの動的な操作には Server Actions (src/actions/) を用いることで，クライアントサイドに露出するAPIエンドポイントを隠蔽しつつ，型安全な関数呼び出しとしてバックエンドとの通信を実装している．

\paragraph{ 認証と認可}
認証基盤には Node.js のライブラリである NextAuth.js (src/api/auth/[...nextauth]) を導入し，Google OAuth およびメールアドレス認証によるログインフローを実装した．セッション情報はJWT（JSON Web Token）として発行し，HTTP Only Cookieを用いて管理する．

\subsubsection{バックエンド}
システムのコアロジックを担当するバックエンドには，Node.js フレームワークである NestJS \cite{nestjs} を採用した．TypeScriptによる静的型付けと，依存性の注入（DI）によるモジュール構成を利用し，機能ごとに責務を分割した．

\paragraph{モジュール分割による関心の分離}
アプリケーションは機能単位でモジュールに分割されている．
\begin{description}
	\item[User Module] アカウント管理，プロフィール更新
	\item[Auth Module] 認証処理
	\item[Item Module] 作品のCRUD，Markdown解析，在庫管理
	\item[Order Module] 注文作成，決済ステータスの遷移管理
	\item[Project Module] 企画のガバナンス管理，収益分配計算
\end{description}
このようにドメインごとに責務を分離し，機能追加や変更の際に影響範囲を局所化しやすい構成とした．

\paragraph{非同期イベント処理}
本システムでは決済処理をStripeに委譲しているため，決済の成功・失敗や，オークションにおける与信枠の確保の結果は，すべて非同期のWebhookイベントとして通知される．
これを受け取るための専用のエンドポイント (src/webhook) を実装し，Stripeからの署名検証を行った上で，Orderデータベースのステータスを更新する．この処理により，決済の結果を非同期イベントとして取り込み，状態遷移を管理する．

\subsubsection{データベース}
データの永続化には，リレーショナルデータベースである PostgreSQL \cite{postgresql} を採用した．複雑な多対多のリレーション（例：ProjectとCollaborators，ItemとBids）を矛盾なく管理し，ACID特性（原子性，一貫性，独立性，永続性）を備えたトランザクション処理を実現するためである．

\paragraph{Prisma ORMによる型安全なデータアクセス}
アプリケーション層とデータベース層の架け橋として Prisma \cite{prisma} を使用している．schema.prisma ファイルに定義されたデータモデルに基づき，型定義ファイル（TypeScript型）が自動生成される．
これにより，バックエンドの開発において「存在しないカラムへのアクセス」や「型の不一致」といった単純な誤りをコンパイル時に検出しやすくなる．

% \paragraph{スキーマ駆動開発}
% 開発フローにおいては，まず schema.prisma でデータ構造（User, Item, Project等のモデル定義）を記述し，それを元にマイグレーション（prisma migrate）を実行してDBスキーマを更新する手法をとった．これにより，仕様書に定義されたデータモデルと実装コード，データベースのスキーマの同期を図る．

\subsubsection{決済および送金基盤 (Stripe Connect)}
CtoCプラットフォームにおける金銭取引の決済インフラには，Stripe Connect \cite{stripe} を採用した．本システムでは，売り手（クリエイター）への送金管理，本人確認，およびオークション等の決済フローに対応するために，Stripeが提供する機能を利用している．

\paragraph{連結アカウントによるユーザー管理}
プラットフォームに参加するクリエイター（売り手）は，Stripeの「連結アカウント」として管理される．User モデルの stripeAccountId カラムには，Stripe側で発行された一意のアカウントID（acct\_...）が保存される．
これにより，売上の入金先口座の設定や本人確認の手続きをStripe側の機能として取り扱い，プラットフォーム側では識別子の管理と状態の参照を行う．

\paragraph{支払いと送金の分離}
資金フローにおいては，買い手からの支払いを即時に売り手へ送金するのではなく，支払いと送金を分離する方式を採用した．
この方式では，買い手の決済は一度プラットフォームのアカウントに対して行われ，その後，任意のタイミングで売り手の連結アカウントへ送金が実行される．これにより，以下の要件を満たしている．
\begin{description}
	\item[エスクロー機能] 商品の発送完了や受け取り評価が行われるまで，プラットフォーム上で売上を一時的に保持し，トラブル時の返金を容易にする．
	\item[収益分配の柔軟性] プロジェクト主催者への手数料やプラットフォーム手数料を差し引いた上で，正確な金額をクリエイターに分配する．
\end{description}

\paragraph{オークションにおける与信枠の活用}
イングリッシュオークションや抽選販売において，当選後の未払いは課題の一つである．本システムではこれを抑制するため，クレジットカードのオーソリゼーション（与信枠確保）機能を活用した決済フローを構築した．
\begin{description}
	\item[与信枠確保]  入札や抽選応募の時点で，PaymentIntent を作成し，capture\_method: 'manual' オプションを用いてカードの与信枠のみを確保する．この段階では実際の請求は発生しない．
	\item[確定と解放]落札や当選が確定した時点で capture を実行し，売上を確定させる．一方，落選や高値更新が発生した場合は即座に cancel を実行し，与信枠を解放する．
\end{description}
この仕組みは，入札や応募の時点で与信を確保することにより，当選後の未払いの発生を抑制することを目的としている．

\subsection{データモデル設計}
本システムのデータモデルは，User，Item，Project の3つのコアエンティティを中心に設計されている．主要なエンティティの関係性を図\ref{fig:er_diagram}に示す．

\begin{figure}[t]
	\centering
	\begin{tikzpicture}[
			node distance=1.8cm,
			entity/.style={draw, rectangle, rounded corners, align=center, minimum width=2.5cm, minimum height=1.2cm, fill=white, thick},
			attribute/.style={draw, ellipse, align=center, minimum width=2cm, minimum height=0.8cm, fill=white},
			relationship/.style={draw, diamond, aspect=2, align=center, minimum width=2cm, minimum height=1cm, fill=white, thick},
			arrow/.style={-Latex, thick},
			line/.style={thick}
		]
		% Entities
		\node[entity] (user) {\textbf{User}};
		\node[entity, right=4cm of user] (item) {\textbf{Item}};
		\node[entity, below=3cm of user] (project) {\textbf{Project}};

		% Relationships
		% User - Item (Created By)
		\draw[arrow] (user) -- node[above] {作成 (1:N)} (item);

		% User - Project (Owner)
		\draw[arrow] (user) -- node[left] {所有 (1:N)} (project);

		% Project - Item (Contains)
		\draw[arrow] (project.east) -- node[right] {包含 (1:N)} (item.south);

		% User - Project (Collaborates)
		\draw[line, dashed] (user.south east) -- node[sloped, above, font=\footnotesize] {参加 (M:N)} (project.north east);

		% Attributes (Selected)
		\node[attribute, above left=0.5cm of user] (uid) {id, publicId};
		\node[attribute, left=0.5cm of user] (ustripe) {stripeAccountId};
		\draw[line] (user) -- (uid);
		\draw[line] (user) -- (ustripe);

		\node[attribute, above right=0.5cm of item] (iid) {id, price};
		\node[attribute, right=0.5cm of item] (inarrative) {description\\(Narrative)};
		\draw[line] (item) -- (iid);
		\draw[line] (item) -- (inarrative);

		\node[attribute, below left=0.5cm of project] (pid) {id, mode};
		\draw[line] (project) -- (pid);

	\end{tikzpicture}
	\caption{User, Item, Project のER図（主要なリレーションのみ抜粋）}
	\label{fig:er_diagram}
\end{figure}

\subsubsection{Userモデル}
User モデルは，本プラットフォームにおける活動の基点となるユーザーを表すリソースである．単なる認証用アカウント情報に加え，プロフィール情報や決済連携に必要な属性を保持する．

\paragraph{公開識別子とポートフォリオ機能}
各ユーザーには，データベース内部の主キー（id）とは別に，外部公開用の識別子として publicId（CUID）が付与される．これにより，https://domain/[userPubId] のように公開識別子を用いたURLを生成できる．このURLは，ユーザーの出品作品や参加プロジェクト，活動履歴を集約したページとして表示する．

\paragraph{経済的主体としての属性}
CtoC取引における売り手としての機能を果たすため，Stripe ConnectのアカウントIDを stripeAccountId カラムに保持する．これは，本人確認が完了したユーザーにのみ発行されるIDであり，このフィールドの有無によって，システムはユーザーが「出品可能」か「購入専用」かを判別する．また，買い手としての情報は stripeCustomerId に紐づけられ，クレジットカード情報等の機微な決済情報はすべてStripe側のVaultに保存される設計としている．

\paragraph{多層的なリレーション}
Userは他のリソースと多層的な関係を持つ．自身が作成した作品（items）だけでなく，他者と共同制作した作品（contributingItems）や，主催する企画（ownedProjects），参加者として関わる企画（contributingProjects）へのリレーションを保持し，個人の活動の広がりをグラフ構造として表現する．

\subsubsection{Itemモデル}
Item モデルは，取引の対象となる「作品」を管理するリソースである．一般的なECサイトの商品モデルと比較して，本システムでは作品の説明文や制作背景（制作ログ）を保存する点に重点を置く．

\paragraph{説明文の保存}
作品の説明文や制作過程を記録するために，description フィールドにはMarkdown形式のテキストデータを保存する．フロントエンド側ではリッチテキストとしてレンダリングし，画像や動画の埋め込みを含めて表示する．また，展示会場等でQRコード経由で参照する用途も想定し，作品情報へアクセスできるようにした．

\paragraph{販売ロジックの抽象化}
一点物や限定品など，作品の性質に応じた販売形態を選択可能にするため，salesMethod カラム（ENUM型）を定義している．
	\begin{description}
		\item[AUCTION] イングリッシュオークション形式．currentPrice や endTime と連動し，入札を受け付ける．
		\item[LOTTERY] 抽選販売形式．事前与信を用いた応募ロジックが適用される．
		\item[FIXED\_PRICE] 定額販売形式．購入と同時に決済を確定する．
	\end{description}

\paragraph{ステータス管理}
作品のライフサイクルを管理するために，status カラム（ENUM型）を用いる．出品前の DRAFT，販売中の FOR\_SALE，取引成立後の SOLD などの状態を定義し，状態に応じて操作を制御する．また，Stripeの商品マスタと同期するために stripeProductId および stripePriceId を保持する．

\subsubsection{Projectモデル}
Project モデルは，複数の User と Item を束ねる企画単位のリソースである．本システムでは，Projectを権限管理と収益分配の単位として扱う．

\paragraph{ガバナンス構造の表現}
\begin{description}
	\item[Owner] プロジェクトの作成者であり，管理者権限を持つ．ownerId 外部キーによってUserモデルと一対多で結ばれる．
		\item[Collaborators] 企画に参加するクリエイター群．中間テーブルを介した多対多のリレーションによって定義される．
		      この構造により，招待制の活動や主催者が承認を行う企画など，参加形態の違いを表現できる．
\end{description}

\paragraph{収益分配の単位}
Project は紐づけられた作品群（items）の集合体として機能する．Item モデルは projectId を外部キーとして持ち，どのProjectに属するかを示す．このリレーションに基づき，Project単位での売上集計や主催者手数料の計算を行う．

\subsection{Project管理方式}
本プラットフォームにおける Project は，複数ユーザーの共同制作や販売活動を表す単位であり，参加権限や公開フロー，収益分配に関するルールを持つ．
現実世界の創作活動には，大学のサークル活動のような水平的な人間関係に基づくものから，コンテストのように主催者が強い権限を持つ垂直的な構造，あるいはインターネット上のミームのように不特定多数が自律的に参加するものまで，多種多様な形態が存在する．
これらを単一のシステム仕様でカバーすることは困難であるため，本システムでは Project リソースに対して3つの異なるガバナンスモード（管理方式）を実装した．

\subsubsection{Cooperative Mode}
\paragraph{意義と適用領域}
Cooperative Mode は，既知のメンバーによる小規模から中規模の共同制作を想定したモードである．大学のサークル活動，グループ展，特定のクリエイター同士のコラボレーション企画などを対象とする．


\paragraph{仕様詳細}
\begin{description}
		\item[参加権限] 「招待制」を採用する．プロジェクトオーナーまたは既存メンバーからの招待リンク（署名付きURL）を受け取ったユーザーのみが，Collaboratorとして参加できる．
		\item[作品管理] 参加メンバーは，自身の判断で作品（Item）をProjectに紐づけ，即座に公開することができる．オーナーによる事前承認プロセスは存在しない．
		\item[収益構造] 売上は各作品の制作者に送金し，主催者手数料は設定できない仕様とした．
\end{description}

\subsubsection{Managed Mode}
\paragraph{意義と適用領域}
Managed Mode は，明確な主催者が存在し，品質管理やレギュレーションの遵守が求められる階層型の共同体である．企業主催のコンテスト，有名インフルエンサーによる企画展，アンソロジーの編纂などを想定している．
Managed Mode では，主催者に承認や削除等の管理権限を与え，主催者手数料（Organizer Fee）を設定可能とした．

\paragraph{仕様詳細}
\begin{description}
	\item[参加権限] 「公募制」を採用する．ユーザーはProjectに対して参加申請を行い，オーナーが管理画面でこれを「承認」または「拒否」することでメンバーシップが確定する．
	\item[作品管理] 出品された作品は一時的に PENDING ステータスとなり，オーナーが内容を確認し承認するまで公開されない．また，オーナーは規約違反の作品を強制的にプロジェクトから除外する権限を持つ．
	\item[収益構造] Stripe Connectの "Separate Charges and Transfers" APIを活用し，「主催者手数料」 の設定を可能にしている．取引成立時，システムは売上総額からプラットフォーム手数料と主催者手数料を自動的に控除し，残額を作品制作者へ送金する．
\end{description}

\subsubsection{Theme Mode}
\paragraph{意義と適用領域}
Theme Mode は，共通のテーマの下で不特定多数が参加可能なモードである．インターネット上のハッシュタグや季節イベント等のように，参加者が広く分散する状況を想定する．本モードでは参加申請や承認プロセスを設けず，参加および公開を即時に行えるようにした．

\paragraph{仕様詳細}
\begin{description}
		\item[参加権限] 「自由参加」を採用する．アカウントを持つ全ユーザーは，許可を得ることなく即座にProjectに参加できる．
		\item[作品管理] 紐づけられた作品は即時公開される．オーナー（発起人）は，通報対応を除き，他者の作品を削除する権限を持たない．
		\item[収益構造] 主催者手数料の設定は不可である．売上はすべて作品制作者に送金する．
\end{description}

\subsubsection{Project 管理方式の比較}
各モードにおける権限と金銭的フローの差異を示す。
\begin{table}[h]
		\caption{Project管理方式の比較}
		\label{tab:project_mode_comparison}
		\centering
		\begin{tabular}{lccccc} % l:Left, c:Center, r:Right 寄せ
		\hline
		方式名         & 参加フロー       & 作品公開フロー     & 主催者権限    & 収益分配(Organizer Fee) \\
		\hline \hline
		Cooperative & 招待のみ        & 即時公開        & メンバー除名可  & 不可                  \\
		Managed     & 申請 $\to$ 承認 & 投稿 $\to$ 承認 & 作品削除・否認可 & 可                   \\
		Theme       & 自由参加        & 即時公開        & 管理不可     & 不可                  \\
		\hline
	\end{tabular}
\end{table}

\subsection{統合型検索システム}
本プラットフォームでは，User，Item，Project の3つの主要リソースを横断的に検索できる統合検索機能を実装した．ユーザーの検索意図は，特定の作品の購入だけでなく，企画や作家の活動の把握など多様であるため，単一の検索窓から複数のリソースを対象に検索できる構成とした．

\subsubsection{設計思想: 探索的検索への対応}
従来のEコマースサイトにおける検索システムは，SKU（最小管理単位）ベースの商品検索に特化しており，ユーザーが明確な購買目的を持っていることを前提とすることが多い．
しかし，一点物や創作活動を扱う本プラットフォームにおいては，ユーザーは必ずしも具体的な商品名を検索するとは限らない．「折り紙」「ガレージキット」といったジャンル名や，「学園祭」といったイベント名から検索を開始し，そこから関連するクリエイターや作品群へと興味を広げていく探索的検索の行動様式が見られる．
したがって，検索システムは単一のリソースリストを返すだけでなく，複数のリソース種別をまとめて提示し，関連情報を辿れる構成が望ましい．

\subsubsection{アーキテクチャ: 並列クエリ実行モデル}
統合検索のバックエンド処理においては，異なるデータ構造を持つ複数テーブルに対する検索を効率的に処理するため，並列クエリ実行モデルを採用した．
具体的には，ユーザーが入力した単一の検索クエリに対し，バックエンド（NestJS）は以下の処理を非同期かつ並列に実行する．
\begin{description}
	\item[Project Search] プロジェクト名および概要文に対する全文検索またはベクトル検索．
	\item[User Search] ユーザー名およびプロフィール文に対する検索．
	\item[Item Search] 作品名，説明文（Markdown），タグに対する検索．
\end{description}
これらのクエリは Promise.all 等を用いて並行してデータベース（PostgreSQL）に発行され，得られた検索結果を単一のレスポンスオブジェクトに統合してクライアントへ返却する．これにより，リソース種別ごとに検索画面を分割する必要を減らす．

\subsubsection{インターフェース: 階層的情報の統合表示}
検索結果の表示画面においては，情報の重要度とユーザーの認知負荷を考慮し，リソースタイプごとに優先順位を設けた階層的表示を採用した．
\begin{description}
	\item[上部: 関連プロジェクト] 検索結果の上部に，クエリに関連性の高い Project を最大3件表示する．Projectを文脈単位として扱うため，個別作品より上に配置した．
	\item[中部: 関連クリエイター] 次に，関連する User を最大5件表示する．
	\item[下部: 関連作品] 最下部には，関連する Item をグリッド形式で表示する．ここでは無限スクロールを採用し，追加結果を段階的に取得・表示する．
\end{description}
また，検索結果画面のサイドバーには，属性による絞り込み（ファセットナビゲーション）を配置した．ユーザーは，統合検索によって得られた結果に対し，価格帯，カテゴリ，販売方式（オークション・定額など）といった属性で絞り込みを行うことができる．

\subsection{販売形態と価格決定アルゴリズム}
本プラットフォームが扱う一点物や希少在庫の流通では，需要が供給を上回る状況が想定される．固定価格販売のみでは先着順となりやすいため，本システムでは複数の販売方式を実装した．また，全ての方式において，Stripe Connect APIを用いたクレジットカードの与信枠確保を利用し，支払い不履行の発生を抑制することを目的とした．

\subsubsection{イングリッシュ・オークション}
在庫が単一（$N=1$）である一点物の作品に対し，最も高い評価額を持つ購入希望者を決定するための標準的な競り上げ方式である．

\paragraph{自動入札アルゴリズム}
ユーザーの操作量とサーバー負荷の軽減を考慮し，Vickrey Auction の概念を取り入れた自動入札方式を採用した．ユーザーは「現在価格」ではなく，自身の「支払ってもよい最高額」を入力する．システムは，2番目に高い入札額（または開始価格）に最小入札単位を加えた額を「現在価格」として算出・更新する．この方式により，最高額の提示後に再入札を繰り返す操作を減らすことを狙う．

\paragraph{連続的な与信枠管理フロー}
本システムでは，最高入札者の入れ替わりに合わせて与信枠を更新するため，最高入札者が変化するたびに決済リソースの切り替えを行う．具体的なフローは以下の通りである．
\begin{description}
	\item[1. 新規与信] 新たな高値入札者が現れた際，システムはそのユーザーのクレジットカードに対し，入札額全額の与信枠確保（paymentIntents.create with capture\_method: 'manual'）を試行する．これに失敗した場合，入札自体を却下する．
	\item[2. DB更新] 与信確保に成功した場合のみ，データベース上の Item レコード（現在価格，リーダーID）および Bid レコードを更新する．
	\item[3. 旧与信解放] 更新完了後，直前の最高入札者の与信枠（PaymentIntent）に対してキャンセル処理（paymentIntents.cancel）を非同期的に実行し，枠を即時解放する．
\end{description}
このプロセスにより，オークション終了時の支払い不履行の発生を抑制する．

\subsubsection{複数点式オークション}
在庫が複数（$N > 1$）存在するが，需要がそれを上回る場合（例：限定5個のガレージキット）に適用する販売方式である．当選者の支払額を入札額とする Pay-as-Bid 方式を採用した．
\paragraph{当選者決定ロジック}
入札額の高い順にソートを行い，上位 $N$ 名を当選者として確定する．
\[
	B_{1} \ge B_{2} \ge \dots \ge B_{N} \ge \dots \ge B_{M}
\]
ここで $B_{i}$ は $i$ 番目のユーザーの入札額であり，上位 $N$ 名までの入札が有効となる．同額入札が存在する場合は，先着優先として順位付けを行う．
\paragraph{Pay-as-Bid方式}
当選者全員が $B_{N}$（ボーダーライン価格）を支払う単一価格方式ではなく，各当選者が自身の提示した $B_{i}$ を支払う Pay-as-Bid 方式を採用した．
この方式では，当選者ごとに支払額が異なるため，落札結果の支払額は入札額に依存する．
\paragraph{取引および決済フローの詳細}
本方式では，複数の当選候補者が並存するため，与信確保と解放を複数件に対して行う．
\begin{description}
		\item[Step 1: 入札と与信確保 ] ユーザーが入札を行う際，システムは入札額全額の与信枠確保を実行する．この時点で決済は確定しないが，カードの利用枠を確保することで，入札後の支払い拒否の発生を抑制する．
	\item[Step 2: ボーダーラインの可視化と競争] オークション期間中，入札画面には「現在，上位 $N$ 位に入るための最低価格（$B_{N}$）」がリアルタイムで表示される．ユーザーはこのボーダーラインを参考に，自身の予算内で入札額を調整する．
	\item[Step 3: 決着と一括決済] 決着と一括決済 (Settlement)終了時刻（endTime）に到達した時点で，システムは全入札を確定させる．
	      上位 $N$ 名: 確保していた与信枠に対し capture を実行し，売上を確定させる．
	      落選者 ($N+1$ 位以下): 確保していた与信枠に対し cancel (Void) を実行し，即座に解放する．
\end{description}
\subsubsection{抽選販売}
価格の高騰の抑制や機会の平等を目的とする場合に用いる方式である．本方式では，応募プロセスにおいて事前与信を行う．
\paragraph{フローとステート管理}
\begin{description}
	\item[応募時] ユーザーが「応募」ボタンを押下した瞬間に，商品価格分の与信枠確保を実行する．確保に失敗した場合，応募は受理されない．
	\item[抽選時] 擬似乱数生成器を用いて当選者を選出する．
	\item[確定時] 当選者の取引ステータスを CAPTURED に更新し，決済を確定させる．同時に，落選者に対しては VOID 処理を行い，与信枠を即時解放する．
\end{description}
この仕組みにより，当選後の未払いによる再抽選の発生を抑制し，運用負荷の低減を図る．

\subsubsection{定額販売}
在庫が無制限，あるいは需給バランスが安定している作品向けの，出展者が価格を決定し販売するEコマースと同様の販売方式である．クレジットカードによる即時決済（Capture）によって取引が成立する．

\subsection{テストデータに対する要件と課題}
このように文脈を扱い，かつ複雑なリレーションを持つプラットフォームの開発において，テストデータの用意は課題となる．

\begin{enumerate}
	\item \textbf{リレーションの整合性}:
	      ランダムなデータを生成すると，「ユーザーが未参加のプロジェクトに関連する作品を出品している」といった外部キー制約違反や論理矛盾が頻発する．これを防ぐためには，データベースの依存関係を深く理解した生成ロジックが必要となる．

		\item \textbf{コンテンツのリアリティ}:
		      UIの検証（例えば，長い説明文がレイアウト崩れを起こさないか，検索機能が適切にキーワードを拾うか）を行うためには，「Lorem Ipsum」に代表される無意味なダミーテキストではなく，ドメイン固有の用語や適切な長さを持つ「リアルなテキスト」が必要である．特に本プラットフォームでは「制作ログ」や「物語」が主要なコンテンツであるため，その質がUX評価に直結する．

	\item \textbf{多様性の確保}:
	      検索アルゴリズムやレコメンデーション機能の性能を評価するためには，データの分布に偏りがあってはならない．特定のカテゴリ（例：アクセサリー）だけにデータが集中すると，システムの性能を正しく評価できない．
\end{enumerate}

第3章で提案したデータ生成エージェントは，これらの課題，特に整合性と多様性の両立を目的として設計した．本プラットフォームは，提案手法の有効性を評価するための実験環境として用いた．
